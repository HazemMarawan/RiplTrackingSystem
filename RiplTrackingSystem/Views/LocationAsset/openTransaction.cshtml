@model IEnumerable<RiplTrackingSystem.ViewModel.AssetViewModel>
@{
    ViewBag.Title = "openTransaction";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="modal fade" id="recieve_assets_modal" tabindex="-1" role="dialog" aria-hidden="true">
    <form action="" method="post" enctype='multipart/form-data'>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_title"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-body">
                        <div class="form-row">
                            <input type="hidden" name="id" id="id" value="0" />
                            <input name="assets" id="assets" type="hidden" class="form-control radius-30" />
                            <input name="transaction_id" id="transaction_id" value="@ViewBag.transcactionID" type="hidden" class="form-control radius-30" />

                            <div class="form-group col-md-12">
                                <label>Note</label>
                                <input type="text" name="notes" id="notes" class="form-control radius-30" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="page-header">
    <nav class="breadcrumb-one" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="javascript:void(0);">Recieve Assets</a></li>
        </ol>
    </nav>
</div>

    <div class="row">
        <div class="form-group col-4">
            <input class="form-control" type="text" id="asset_id" name="asset_id" placeholder="Search">
        </div>
        <div class="form-group col-3">
            <button id="recieve" class="btn btn-primary px-3 radius-30">Recieve</button>
        </div>

        <div class="counter-content">
            <h1 class="ico-counter1 ico-counter"><span id="recievedAssetsCounter">0</span> of @Model.Count()</</h1>
        </div>

    </div>
    <div class="card">
        <div class="card-body">
            <table id="assetsTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th></th>
                        <th>#</th>
                        <th>Type</th>
                        <th>Tag ID</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var asset in Model)
                    {
                        <tr>
                            <td><input type='checkbox' class='checkedAsset' id="@asset.tag_id" value='@asset.id'></td>
                            <td>@asset.id</td>
                            <td>@asset.type</td>
                            <td>@asset.tag_id</td>
                        </tr>
                    }
                </tbody>
                <tbody id="asset_body">
                </tbody>
            </table>
        </div>
    </div>

@section scripts
{
    <script>
        $(document).ready(function () {
            
            assetArray = [];
            var array = @Html.Raw(Json.Encode(@Model));
            for(var i = 0; i < array.length; i++) {
                assetArray[i] = array[i].tag_id;
            }

            $("#asset_id").change(function () {
                if (assetArray.includes($("#asset_id").val())) {
                    $("#" + $("#asset_id").val()).prop('checked', true);
                    $("#asset_id").val("");
                    $("#asset_id").focus();
                    updateCounter();

                }
                else {
                    Swal.fire({
                        icon: "error",
                        title: "Not Found!",
                        text: "Transaction Doesn't Contain this Asset"
                    });
                }
            });

            $("#recieve").click(function () {

                Swal.fire({
                    title: 'Do you want to recieve this transcation?',
                    showCancelButton: true,
                    confirmButtonText: 'Save'
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */
                    if (result.isConfirmed) {
                        var checkedVals = $('.checkedAsset:checkbox:checked').map(function () {
                    return this.value;
                }).get();

                var modal = $('#recieve_assets_modal').clone();
                var action = '@Url.Action("recieveAssets", "LocationAsset")';
                modal.find('form').attr('action', action);
                modal.find('#modal_title').text('Recieve Asset');
                modal.execModal({
                    progressBar: 'progress_bar',
                    progressText: 'progress_text',
                }, function (data) {
                        location.href = "/LocationAsset/recieve";

                }, function (response) {

                }, function (dialog) {
                        dialog.find('#assets').val(checkedVals.join(","));

                });
                    } else if (result.isDenied) {
                        Swal.fire('Changes are not saved', '', 'info')
                    }
                })


            });

            function updateCounter() {
                var checkedVals = $('.checkedAsset:checkbox:checked').map(function () {
                    return this.value;
                }).get();

                $("#recievedAssetsCounter").text(checkedVals.length);
            }

            $(".checkedAsset").click(function () {
                updateCounter();
            });
        });
    </script>
}